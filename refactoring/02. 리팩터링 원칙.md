# 02. 리팩터링 원칙

**리팩터링**: 프로그램의 동작(실행 결과)은 유지한 채, 코드베이스가 이해하기 쉬운 구조가 되도록 코드 개선을 하는 행위.

- '성능 개선'과 '리팩터링' 둘 다 실행 결과 유지한 채로 코드를 수정하지만, 코드를 수정하는 목적(성능 향상 vs 코드 구조 개선)이 다름.
- 성능 개선 시 코드의 구조가 더 난해해질 수 있으며, 리팩터링 시 성능이 나빠질 수 있음.

리팩터링을 적용한 워크플로우에서는 두 가지 '모드' 사용

- '기능 추가' 모드: 추가하려는 기능 외의 기존 코드는 최대한 건드리지 않고, 신규 기능의 코드에 집중해서 개발
- '리팩터링' 모드: 신규 기능을 개발하지 않고, 기존 코드의 구조 개선에 집중

일반적으로 개발을 진행할 때는 기능 추가를 하는 과정 중에서 틈틈이 리팩터링을 진행함. 그래서 작업을 할 때 이 두 가지 작업 방식(모드)을 엄격히 구분해서 한 번에 한 가지에만 집중하도록 해야 함. 물론 둘 중 딱 한 가지만 쭉 길게 진행하는 프로세스보다, 둘을 번갈아 가면서 짧은 주기로 진행하는 프로세스가 더 현실적임. 리팩터링을 작은 단위로 진행하면 이렇게 둘을 자주 번갈아 해도 문제가 되지 않음.

리팩터링을 하는 이유는 생산성 향상을 하기 위함이다. 리팩터링을 하면 코드의 가독성이 좋아지고 설계가 좋아진다. 좋은 설계를 가진 코드베이스는 신규 기능을 개발하기도 쉽고 중간에 발생하는 버그를 찾고 해결하기가 쉬워지며, 최종적으로 이 모든 것이 개발 생산성을 향상한다. 보통은 리팩터링을 추가로 수행하는 데에 시간이 많이 소요된다고 생각이 되지만, 워크플로우에 리팩터링을 잘 적용하면 오히려 좋은 설계 위에서 개발하니까 개발 속도가 빨라진다고 함.

리팩터링을 언제 하느냐

- 3의 법칙: 어떤 코드를 중복으로 세 벌 짜게 되었을 때, 리팩터링을 해서 중복을 없앤다.
- '준비'를 위한 리팩터링: 신규 코드를 작성하기 전에, 먼저 신규 코드 작성이 용이한 구조가 되도록 기존 코드를 수정함.
- '이해'를 위한 리팩터링: 코드 분석을 할 때, 그냥 코드를 읽기만 하는 것이 아니라, 코드를 읽어 가면서 개선할 수 있는 부분들을 바로 개선함으로 해서 나의 코드에 대한 이해를 코드상에 바로 반영하고, 추후 테스트를 통해 내 이해가 정확한지 검증을 하기도 함.
- 쓰레기 줍기: 개발을 진행하다가 코드베이스의 다른 부분에서 코드 악취를 발견했을 때 그냥 지나치지 않고, 그 부분을 개선하는 것
- 계획된 리팩터링: 리팩터링을 위한 시간을 따로 명시적으로 잡아놓는 방식. 그러나 너무 많은 시간과 인력을 리팩터링에 한번에 사용하는 것은 비효율적이어서 추천하지 않음.
- 코드 리뷰 중에: 코드 리뷰를 하면서 리뷰어가 자신의 이해를 리팩터링 작업을 통해 코드상에 반영함(이해를 위한 리팩터링과 비슷)

리팩터링을 하지 않아도 되는 경우

- 외부 API, 외부 모듈의 경우
- 구조 개선보다 코드를 새로 짜는 게 더 빠른 경우

리팩터링을 할 때 당위성의 관점(리팩터링을 하는 것이 옳다)으로 하면 안 되고, 리팩터링의 목적은 경제성(개발 속도 향상)에 있다는 관점으로 진행해야 함.

브랜치 관리: 보통 Git을 프로젝트에서 사용하게 되면 팀원들은 각자 자기가 개발하는 기능별로 브랜치를 생성해서 소스 관리를 함. 그런데 이렇게 하면 종종 자기 브랜치를 며칠씩 오래 로컬에서만 가지고 있다가 개발 완료되었을 때 한꺼번에 마스터 브랜치에 소스를 올리게 됨. 이렇게 하면 다른 개발자들이 마스터 브랜치를 자기 기능 브랜치로 머지/리베이스 시 충돌이 자주 일어나게 됨. 충돌을 줄이기 위해서 각자 자기가 작업하는 내용을 최소 하루에 한 번 올리는 프로세스가 필요하며, 이런 프로세스를 CI(지속적 통합)라고 함. CI 진행 시에는 각자 자기 작업 내용을 마스터에 올릴 때 오류가 나지 않도록 조금 더 신경을 써야 함. CI가 진행되는 환경에서 리팩터링을 하기가 훨씬 쉬움.

점진적 설계: 개발 초기 단계에서 모든 설계를 확정하는 방법보다, 일단 개발을 진행하고, 리팩터링을 통해서 계속해서 설계를 개선하는 방법이 바람직함. 처음부터 설계의 모든 부분을 완벽하게 예상하기가 매우 어렵기도 하고, 한번 예상하고 가정해서 개발 진행 후 리팩터링을 진행하지 않는다면 코드베이스가 수정에 취약한 구조가 되며, 설계할 때는 필요한 줄 알았는데 나중에 알고 보니 필요 없게 된 부분을 개발하는 데에 엉뚱하게 노력을 하게 될 수 있음.

성능의 관점에서도 마찬가지고 점진적 설계가 필요함. 어느 정도 진행된 결과물이 나올 때까지는 코드의 어느 부분에서 시간이 많이 소요될지 정확히 예상하기가 어려움. 결과물이 있는 상태에서 프로파일러를 돌려서 실제 시간 소요를 파악하고 성능 개선을 하는 쪽이 효율적.

리팩터링을 할 때는 단순 텍스트 에디터 말고 IDE를 사용하자. IDE는 구문 트리가 있기 때문에 텍스트 에디터보다 훨씬 정확하게 리팩터링 진행 가능.
